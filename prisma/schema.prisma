// AutoDiag - Diagnosis Service
// Prisma Schema - ALIGNED WITH CURRENT DOMAIN ENTITIES
// Architecture: Classification, Urgency, Cost are SEPARATE concerns

generator client {
  provider             = "prisma-client-py"
  recursive_type_depth = 5
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// DIAGNOSIS SESSION (Chat con IA)
// ============================================

model DiagnosisSession {
  id          String   @id @default(uuid())
  
  // Foreign Keys
  userId      String
  vehicleId   String
  
  // Session state
  status      SessionStatus @default(ACTIVE)
  
  // Conversation
  messages    DiagnosisMessage[]
  
  // AI summary (optional)
  summary     String?
  
  // Related classification (one-to-one)
  classification    ProblemClassification?
  
  // Related recommendations (one-to-many)
  recommendations   WorkshopRecommendation[]
  
  // Timestamps
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  updatedAt   DateTime  @updatedAt
  
  @@index([userId])
  @@index([vehicleId])
  @@index([status])
  @@index([startedAt])
  @@map("diagnosis_sessions")
}

enum SessionStatus {
  ACTIVE
  COMPLETED
  ABANDONED
}

// ============================================
// DIAGNOSIS MESSAGE (Chat messages)
// ============================================

model DiagnosisMessage {
  id          String   @id @default(uuid())
  
  sessionId   String
  session     DiagnosisSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  role        MessageRole
  content     String   @db.Text
  
  attachments Json?
  
  timestamp   DateTime @default(now())
  
  @@index([sessionId])
  @@index([timestamp])
  @@map("diagnosis_messages")
}

enum MessageRole {
  USER
  ASSISTANT
}

// ============================================
// PROBLEM CLASSIFICATION (ML Classifier ONLY)
// ============================================
// NOTE: Urgency and Cost are NOT stored here.
// They are calculated on-demand by separate services.
// This follows SRP (Single Responsibility Principle).

model ProblemClassification {
  id          String   @id @default(uuid())
  
  // Parent session (one-to-one)
  sessionId   String   @unique
  session     DiagnosisSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  // ML Classification Results ONLY
  category    ProblemCategory
  subcategory String?
  
  // ML Confidence
  confidenceScore Float  // 0.0 to 1.0
  
  // Detected symptoms
  symptoms    String[]
  
  // Timestamp
  createdAt   DateTime @default(now())
  
  @@index([sessionId])
  @@index([category])
  @@index([createdAt])
  @@map("problem_classifications")
}

enum ProblemCategory {
  ENGINE
  TRANSMISSION
  BRAKES
  ELECTRICAL
  AIR_CONDITIONING
  SUSPENSION
  EXHAUST
  FUEL_SYSTEM
  COOLING_SYSTEM
  TIRES
  BATTERY
  LIGHTS
  OTHER
}

// ============================================
// WORKSHOP RECOMMENDATION (ML Recommender)
// ============================================

model WorkshopRecommendation {
  id          String   @id @default(uuid())
  
  sessionId   String
  session     DiagnosisSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  workshopId  String
  
  matchScore  Float    // 0.0 to 1.0
  
  reasons     String[]
  
  // Cached workshop metadata
  workshopName String
  distanceKm   Float?
  rating       Float?
  
  createdAt   DateTime @default(now())
  
  @@index([sessionId])
  @@index([workshopId])
  @@index([matchScore])
  @@map("workshop_recommendations")
}

// ============================================
// SENTIMENT ANALYSIS (BERT NLP)
// ============================================

model SentimentAnalysis {
  id          String   @id @default(uuid())
  
  text        String   @db.Text
  
  context     Json?
  
  label       SentimentLabel
  score       Float    // 0.0 to 1.0
  
  scores      Json     // {positive, neutral, negative}
  
  analyzedAt  DateTime @default(now())
  
  @@index([label])
  @@index([analyzedAt])
  @@map("sentiment_analyses")
}

enum SentimentLabel {
  POSITIVE
  NEUTRAL
  NEGATIVE
}

// ============================================
// ANALYTICS METRICS (Admin Dashboard)
// ============================================

model AnalyticsMetric {
  id          String   @id @default(uuid())
  
  metricType  String
  
  value       Json
  
  period      String?
  periodDate  DateTime?
  
  createdAt   DateTime @default(now())
  
  @@index([metricType])
  @@index([periodDate])
  @@map("analytics_metrics")
}

// ============================================
// ML MODEL METRICS (Performance Tracking)
// ============================================

model MLModelMetric {
  id          String   @id @default(uuid())
  
  modelName    String
  modelVersion String
  
  metrics     Json
  
  sampleSize  Int?
  
  createdAt   DateTime @default(now())
  
  @@index([modelName])
  @@index([createdAt])
  @@map("ml_model_metrics")
}
